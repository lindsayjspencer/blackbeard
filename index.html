<!DOCTYPE html>
<html lang="en">

<head>
    <title>Blackbeard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script defer src="/jquery/dist/jquery.min.js"></script>
    <link defer type="text/css" rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="/main.css">
    <link defer rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous">
    <script defer src="/bootstrap/dist/js/bootstrap.min.js"></script>
    <script defer src="/tween.umd.js"></script>
    <script defer src="https://cdn.socket.io/socket.io-1.7.3.js"></script>
</head>

<body>
    <div class="game-screen d-flex flex-column align-items-center">
        <div class="main-logo mb-2 mt-auto">
            <i class="fas fa-skull fa-3x text-warning"></i>
        </div>
        <h3 class="mt-2">
            Blackbeard
        </h3>
        <div class="d-flex flex-row game-screen-options init-loading justify-content-center mt-3 w-100 text-black-50">
            <span class="loading mr-2">Loading</span>
            <span>
                <i class="fas fa-spinner fa-spin fa-fw fa-lg"></i>
            </span>
        </div>
        <div class="input-group game-screen-options hide mb-auto">
            <button class="btn btn-outline-secondary init-btn m-auto btn-block" type="button">Initiate</button>
        </div>
    </div>

    <div class="cover-container d-flex h-100 p-3 mx-auto flex-column w-100">
      <header class="masthead">
        <div class="inner">
          <h3 class="masthead-brand">Blackbeard</h3>
          <nav class="nav nav-masthead justify-content-center">
            <a class="nav-link active" href="#">Home</a>
            <a class="nav-link" href="#">Settings</a>
          </nav>
        </div>
      </header>

      <main role="main" class="inner cover">
          <div class="torrents-container d-flex flex-column w-100">

          </div>
      </main>
    </div>

    <script type="module">

        var activeTorrents, updateLoop, listLoop, displayLoop;

        var activeTorrents = [];
        function initiateSockets() {

            const socket = io();

            socket.on('torrentList', function(torrents) {
                var tempTorrents = [];
                torrents.torrents.forEach((item, i) => {
                    tempTorrents.push(item);
                });
                activeTorrents = tempTorrents
            });

            socket.on('update', function(torrents) {
                torrents.torrents.forEach((tor)=>{
                    activeTorrents.forEach((item) => {
                        if(item.id == tor.id) {
                            item.leftUntilDone = tor.leftUntilDone;
                            item.rateDownload = tor.rateDownload;
                            item.percentDone = tor.percentDone;
                        }
                    });
                });
            });

            function update_loop() {
                socket.emit('checkping', "yes")
            }

            function list_loop() {
                socket.emit('sendList', "yes")
            }

            function display_loop() {
                activeTorrents.forEach((item) => {
                    if($(".torrent-container-"+item.id).length==0) {
                        // draw torrent
                        console.log("draw");
                        $(".torrents-container").append(`
                            <div class="torrent-container-${item.id} d-flex">
                                <div class="id">${item.id}</div>
                                <div class="name text-truncate">${item.name}</div>
                                <div class="time"></div>
                            </div>
                            <div class="torrent-progress-${item.id} mb-2">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                </div>
                            </div>
                        `);
                    } else {
                        // update torrent
                        console.log("update");
                        // $(".torrent-container-"+item.id+" .status").html(item.status);
                        $(".torrent-container-"+item.id+" .time").html(Math.round(item.leftUntilDone/item.rateDownload)+"s");
                        $(".torrent-progress-"+item.id+" .progress-bar").html(Math.round(item.percentDone*100)+"%");
                        $(".torrent-progress-"+item.id+" .progress-bar").css("width", Math.round(item.percentDone*100)+"%");
                    }
                });
            }

            updateLoop = setInterval(update_loop, 200);
            listLoop = setInterval(list_loop, 5000);
            displayLoop = setInterval(display_loop, 200);

        }

        window.onload = (e) => {
            $(".game-screen-options").toggleClass("hide");
            $("html").on("keyup", function(e) {
                if(e.keyCode == 13) {
                    $(".init-btn").click();
                }
            });
            $(".init-btn").on("click", function(){
                initiateSockets();
                $("html").off("keyup");
                $(".game-screen").addClass("hide");
                setTimeout(function(){
                    $(".game-screen").remove();
                }, 600);
            });
        }


    </script>
</body>

</html>
